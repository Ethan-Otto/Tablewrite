# Self-Hosted FoundryVTT REST API Relay Server Setup

## Overview

This project uses a self-hosted local relay server instead of the public hosted service at `https://foundryvtt-rest-api-relay.fly.dev`.

**Relay Server:** http://localhost:3010
**Repository:** https://github.com/ThreeHats/foundryvtt-rest-api-relay
**Local Path:** `/Users/ethanotto/Documents/Projects/dnd_module_gen/relay-server/`

## Architecture

```
Python Scripts (this project)
         ↓
    HTTP/REST API
         ↓
Local Relay Server (localhost:3010)
         ↓
    WebSocket Connection
         ↓
FoundryVTT REST API Module
         ↓
FoundryVTT Instance (localhost:30000)
```

## Quick Start

### 1. Start Relay Server

```bash
cd relay-server
docker-compose -f docker-compose.local.yml up -d
```

### 2. Verify Relay is Running

```bash
curl http://localhost:3010/health
```

Expected: `{"status":"ok",...}`

### 3. Configure FoundryVTT

In FoundryVTT:
1. Go to **Game Settings → Module Settings → Foundry REST API**
2. Change **Relay Server URL** from:
   - `https://foundryvtt-rest-api-relay.fly.dev`
   - to: `http://localhost:3010`
3. **Save** settings
4. Module should show "Connected" status

### 4. Run Connection Test

```bash
uv run python scripts/test_relay_connection.py
```

Expected: All tests pass

## Configuration

### Environment Variables

The project uses these relay-related environment variables (in `.env`):

```env
FOUNDRY_RELAY_URL=http://localhost:3010
FOUNDRY_LOCAL_URL=http://localhost:30000
FOUNDRY_LOCAL_API_KEY=<your_api_key_from_foundry>
FOUNDRY_LOCAL_CLIENT_ID=<your_client_id_from_foundry>
```

**Note:** API key and client ID remain the same - they were generated by the FoundryVTT module and work with any relay server.

### Relay Server Configuration

The relay server uses these settings (in `relay-server/.env`):

```env
NODE_ENV=development
PORT=3010
DB_TYPE=memory
WEBSOCKET_PING_INTERVAL_MS=20000
CLIENT_CLEANUP_INTERVAL_MS=15000
REDIS_ENABLED=false
```

**Important:** `DB_TYPE=memory` bypasses authentication for local development.

## Common Commands

### Start Relay Server

```bash
cd relay-server
docker-compose -f docker-compose.local.yml up -d
```

### Stop Relay Server

```bash
cd relay-server
docker-compose -f docker-compose.local.yml down
```

### View Relay Logs

```bash
cd relay-server
docker-compose -f docker-compose.local.yml logs -f relay
```

### Restart Relay Server

```bash
cd relay-server
docker-compose -f docker-compose.local.yml restart relay
```

### Check Relay Status

```bash
docker ps | grep foundryvtt-rest-api-relay
curl http://localhost:3010/health
```

## Troubleshooting

### Relay Server Not Starting

**Symptom:** `docker-compose up` fails or container exits immediately

**Solutions:**
1. Check logs: `docker-compose -f docker-compose.local.yml logs relay`
2. Verify port 3010 is not in use: `lsof -i :3010`
3. Check Docker has enough resources (memory, disk space)
4. Verify Docker is running: `docker ps`

### WebSocket Connection Failed

**Symptom:** FoundryVTT module shows "Disconnected" or API requests timeout

**Solutions:**
1. Verify FoundryVTT is running: `curl http://localhost:30000`
2. Verify FoundryVTT REST API module is enabled in Foundry
3. Check module settings show correct relay URL: `http://localhost:3010`
4. Check relay logs for WebSocket connection messages:
   ```bash
   docker-compose -f docker-compose.local.yml logs relay | grep "Client.*connected"
   ```
5. Try refreshing FoundryVTT or restarting the world

### API Authentication Failed (401 Errors)

**Symptom:** Python client gets 401 Unauthorized errors

**Solutions:**
1. Verify `DB_TYPE=memory` in `relay-server/.env` and `docker-compose.local.yml`
2. Restart relay server after changing configuration
3. Check relay logs for "Using memory store - bypassing API key authentication"
4. Verify API key and client ID are set in project `.env`

### Search Returns No Results

**Symptom:** Search endpoint returns empty results

**Solutions:**
1. Verify QuickInsert module is installed in FoundryVTT
2. Verify search query is correct (case-sensitive)
3. Check search filter syntax: `filter=documentType:JournalEntry`
4. Verify FoundryVTT has content to search (compendiums, items, etc.)

### FoundryVTT Module Shows "Disconnected"

**Symptom:** Module status shows disconnected after changing relay URL

**Solutions:**
1. Refresh FoundryVTT page (F5)
2. Check relay server is running: `curl http://localhost:3010/health`
3. Verify relay URL in module settings: `http://localhost:3010` (not `https://`)
4. Try disabling and re-enabling the module
5. Check browser console (F12) for WebSocket errors

## Performance

**Expected Performance Metrics:**

- Health check: < 50ms
- Search requests: 100-500ms (depends on FoundryVTT response)
- Create/update: 200-800ms (depends on content size)
- Memory usage: 150-200 MB (Docker container)
- CPU usage: < 5% idle, 10-20% under load

## Data Persistence

The relay server uses an **in-memory database** (`DB_TYPE=memory`):
- Data is **not persisted** across restarts
- No database files created
- Faster than SQLite for local development
- Authentication bypassed for convenience

**If you need persistence:**
1. Change `DB_TYPE=memory` to `DB_TYPE=sqlite` in:
   - `relay-server/.env`
   - `relay-server/docker-compose.local.yml`
2. Change command to `pnpm local:sqlite`
3. Restart relay server
4. Note: Will require user registration for API access

## Security Considerations

1. **Local Network Only:** Relay runs on localhost:3010 (not exposed to internet)
2. **No Authentication:** Using memory database bypasses API key validation
3. **No HTTPS:** Uses HTTP for local development (OK for localhost)
4. **Not for Production:** This setup is for local development only

**Production Deployment:** For internet-facing deployments, use:
- HTTPS with valid SSL certificate
- SQLite or PostgreSQL instead of memory database
- Proper API key authentication
- Firewall rules to restrict access
- Consider using the hosted service at fly.dev

## Upgrading Relay Server

### Pull Latest Code

```bash
cd relay-server
git pull origin main
docker-compose -f docker-compose.local.yml down
docker-compose -f docker-compose.local.yml build
docker-compose -f docker-compose.local.yml up -d
```

### Build from Local Changes

```bash
cd relay-server
docker-compose -f docker-compose.local.yml build --no-cache
docker-compose -f docker-compose.local.yml up -d
```

## Alternative: Manual Installation (No Docker)

If you prefer to run without Docker:

```bash
cd relay-server

# Install dependencies
npm install
# or: pnpm install

# Run in development mode (memory database)
npm run local

# Or with SQLite
npm run local:sqlite
```

**Note:** Requires Node.js 20+ installed on your system.

## Apple Silicon (ARM64) Notes

The pre-built Docker image doesn't support ARM64. This project:
- Builds the image locally from source
- Fixed TypeScript compilation error in `src/routes/api/session.ts`
- Uses `docker-compose.local.yml` for local builds

## References

- **Relay Repository:** https://github.com/ThreeHats/foundryvtt-rest-api-relay
- **FoundryVTT Module:** https://github.com/ThreeHats/foundryvtt-rest-api
- **API Documentation:** `relay-server/docs/`
- **Project Integration:** `src/foundry/client.py`, `src/foundry/journals.py`
- **Test Script:** `scripts/test_relay_connection.py`

## Support

**For relay server issues:**
- Check relay logs: `docker-compose -f docker-compose.local.yml logs relay`
- GitHub Issues: https://github.com/ThreeHats/foundryvtt-rest-api-relay/issues
- Discord: https://discord.gg/U634xNGRAC

**For project integration issues:**
- Run test script: `uv run python scripts/test_relay_connection.py`
- Check project logs in `output/runs/*/`
- Verify `.env` configuration
