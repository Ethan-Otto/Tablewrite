[pytest]
# Pytest configuration for D&D Module Converter

# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Test paths
testpaths = tests
pythonpath = src

# Output options
addopts =
    -v
    --tb=long
    --strict-markers
    --disable-warnings
    --durations=20
    --durations-min=1.0
    --junit-xml=test-results.xml
    --log-file=test.log
    --log-file-level=DEBUG
    -m "smoke"

# Global timeout (5 minutes max per test)
timeout = 300
timeout_method = thread

# Asyncio configuration
asyncio_mode = auto
asyncio_default_fixture_loop_scope = session
asyncio_default_test_loop_scope = session

# Anyio configuration (for tool system tests)
anyio_backends = asyncio

# Markers for different test types
# Hierarchy: foundry/gemini -> integration (automatic via conftest.py hook)
markers =
    # Test categories
    smoke: Critical smoke tests (one per major feature, can be unit or integration)
    unit: Pure unit tests with no external dependencies
    slow: Tests taking >10 seconds

    # Integration hierarchy (foundry/gemini auto-add integration marker)
    integration: Base marker for tests requiring external services
    foundry: Requires Foundry WebSocket connection (implies integration)
    gemini: Requires Gemini API key and network (implies integration)

    # Legacy markers (use foundry/gemini instead)
    requires_api: DEPRECATED - use 'gemini' instead
    requires_foundry: DEPRECATED - use 'foundry' instead
    requires_pdf: Tests that require PDF files

    # Async markers
    asyncio: marks tests that use asyncio
    anyio: marks tests that use anyio (async framework agnostic)

    # Utility markers
    flaky: May fail intermittently due to external factors (auto-retries enabled)
    playwright: Uses Playwright browser automation (cannot run in parallel)
    order: Must run in specific order
    timeout: Custom timeout value
    map: Related to map extraction and processing

# Parallel execution (pytest-xdist)
# Use loadscope to group tests by fixture scope - session fixtures run once per group
# This prevents session-scoped fixtures from running N times with N workers

# Logging - verbose output for debugging
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_cli_date_format = %H:%M:%S
